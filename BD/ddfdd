-- This script was generated by the ERD tool in pgAdmin 4.
-- Please log an issue at https://github.com/pgadmin-org/pgadmin4/issues/new/choose if you find any bugs, including reproduction steps.
BEGIN;


CREATE TABLE IF NOT EXISTS public.areas
(
    id_area integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(100) COLLATE pg_catalog."default" NOT NULL,
    id_departamento integer,
    CONSTRAINT areas_pkey PRIMARY KEY (id_area)
);

CREATE TABLE IF NOT EXISTS public.ast
(
    id_ast integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    epp text COLLATE pg_catalog."default",
    maquinaria_equipo_herramientas text COLLATE pg_catalog."default",
    materiales_accesorios text COLLATE pg_catalog."default",
    CONSTRAINT ast_pkey PRIMARY KEY (id_ast)
);

CREATE TABLE IF NOT EXISTS public.ast_actividades
(
    id_ast_actividades integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    id_ast integer NOT NULL,
    num_actividad character varying(200) COLLATE pg_catalog."default",
    secuencia_actividad character varying(300) COLLATE pg_catalog."default",
    personal_ejecutor character varying(150) COLLATE pg_catalog."default",
    peligros_potenciales character varying(350) COLLATE pg_catalog."default",
    acciones_preventivas character varying(350) COLLATE pg_catalog."default",
    responsable character varying(150) COLLATE pg_catalog."default",
    CONSTRAINT ast_actividades_pkey PRIMARY KEY (id_ast_actividades)
);

CREATE TABLE IF NOT EXISTS public.ast_participan
(
    id_ast_participan integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(250) COLLATE pg_catalog."default",
    credencial character varying(100) COLLATE pg_catalog."default",
    cargo character varying(100) COLLATE pg_catalog."default",
    funcion character varying(50) COLLATE pg_catalog."default",
    id_estatus integer NOT NULL,
    CONSTRAINT ast_participan_pkey PRIMARY KEY (id_ast_participan)
);

CREATE TABLE IF NOT EXISTS public.autorizaciones
(
    id_autorizacion integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    id_permiso integer,
    id_supervisor integer,
    id_categoria integer,
    responsable_area character varying(100) COLLATE pg_catalog."default",
    operador_area character varying(150) COLLATE pg_catalog."default",
    CONSTRAINT autorizaciones_pkey PRIMARY KEY (id_autorizacion)
);

CREATE TABLE IF NOT EXISTS public.categorias_seguridad
(
    id_categoria integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT categorias_seguridad_pkey PRIMARY KEY (id_categoria)
);

CREATE TABLE IF NOT EXISTS public.departamentos
(
    id_departamento integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(100) COLLATE pg_catalog."default" NOT NULL,
    correo character varying(100) COLLATE pg_catalog."default",
    extension character varying(20) COLLATE pg_catalog."default",
    "contraseña" character varying(255) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT departamentos_pkey PRIMARY KEY (id_departamento)
);

CREATE TABLE IF NOT EXISTS public.estatus
(
    id_estatus integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    estatus character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT estatus_pkey PRIMARY KEY (id_estatus)
);

CREATE TABLE IF NOT EXISTS public.jefe
(
    id_jefe serial NOT NULL,
    usuario character varying(50) COLLATE pg_catalog."default",
    "contraseña" character varying(100) COLLATE pg_catalog."default",
    CONSTRAINT jefe_pkey PRIMARY KEY (id_jefe)
);

CREATE TABLE IF NOT EXISTS public.permisos_trabajo
(
    id_permiso integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    fecha_hora timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    id_area integer NOT NULL,
    id_departamento integer NOT NULL,
    id_sucursal integer NOT NULL,
    id_tipo_permiso integer NOT NULL,
    id_estatus integer NOT NULL,
    id_ast integer NOT NULL,
    prefijo character varying(50) COLLATE pg_catalog."default",
    CONSTRAINT permisos_trabajo_pkey PRIMARY KEY (id_permiso)
);

CREATE TABLE IF NOT EXISTS public.pt_apertura
(
    id serial NOT NULL,
    id_permiso integer NOT NULL,
    fecha_creacion timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    tipo_mantenimiento character varying(50) COLLATE pg_catalog."default" NOT NULL,
    otro_tipo_mantenimiento character varying(100) COLLATE pg_catalog."default",
    ot_numero character varying(50) COLLATE pg_catalog."default" NOT NULL,
    tag character varying(100) COLLATE pg_catalog."default",
    hora_inicio time without time zone NOT NULL,
    tiene_equipo_intervenir character varying(5) COLLATE pg_catalog."default",
    descripcion_equipo text COLLATE pg_catalog."default",
    fluido character varying(100) COLLATE pg_catalog."default",
    presion character varying(50) COLLATE pg_catalog."default",
    temperatura character varying(50) COLLATE pg_catalog."default",
    antecedentes text COLLATE pg_catalog."default",
    requiere_herramientas_especiales character varying(10) COLLATE pg_catalog."default",
    tipo_herramientas_especiales character varying(255) COLLATE pg_catalog."default",
    herramientas_adecuadas character varying(10) COLLATE pg_catalog."default",
    requiere_verificacion_previa character varying(10) COLLATE pg_catalog."default",
    requiere_conocer_riesgos character varying(10) COLLATE pg_catalog."default",
    observaciones_medidas text COLLATE pg_catalog."default",
    fuera_operacion character varying(10) COLLATE pg_catalog."default",
    despresurizado_purgado character varying(10) COLLATE pg_catalog."default",
    necesita_aislamiento character varying(10) COLLATE pg_catalog."default",
    con_valvulas character varying(10) COLLATE pg_catalog."default",
    con_juntas_ciegas character varying(10) COLLATE pg_catalog."default",
    producto_entrampado character varying(10) COLLATE pg_catalog."default",
    requiere_lavado character varying(10) COLLATE pg_catalog."default",
    requiere_neutralizado character varying(10) COLLATE pg_catalog."default",
    requiere_vaporizado character varying(10) COLLATE pg_catalog."default",
    suspender_trabajos_adyacentes character varying(10) COLLATE pg_catalog."default",
    acordonar_area character varying(10) COLLATE pg_catalog."default",
    prueba_gas_toxico_inflamable character varying(10) COLLATE pg_catalog."default",
    equipo_electrico_desenergizado character varying(10) COLLATE pg_catalog."default",
    tapar_purgas_drenajes character varying(10) COLLATE pg_catalog."default",
    proteccion_especial_recomendada character varying(10) COLLATE pg_catalog."default",
    proteccion_piel_cuerpo character varying(10) COLLATE pg_catalog."default",
    proteccion_respiratoria character varying(10) COLLATE pg_catalog."default",
    proteccion_ocular character varying(10) COLLATE pg_catalog."default",
    proteccion_contraincendio character varying(10) COLLATE pg_catalog."default",
    tipo_proteccion_contraincendio character varying(255) COLLATE pg_catalog."default",
    instalacion_barreras character varying(10) COLLATE pg_catalog."default",
    observaciones_riesgos text COLLATE pg_catalog."default",
    co2_nivel character varying(20) COLLATE pg_catalog."default",
    nh3_nivel character varying(20) COLLATE pg_catalog."default",
    oxigeno_nivel character varying(20) COLLATE pg_catalog."default",
    lel_nivel character varying(20) COLLATE pg_catalog."default",
    descripcion_trabajo text COLLATE pg_catalog."default",
    nombre_solicitante character varying(150) COLLATE pg_catalog."default",
    empresa character varying(150) COLLATE pg_catalog."default",
    CONSTRAINT pt_apertura_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.pt_no_peligroso
(
    id_ptnp integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    id_permiso integer NOT NULL,
    nombre_solicitante character varying(100) COLLATE pg_catalog."default" NOT NULL,
    descripcion_trabajo character varying(350) COLLATE pg_catalog."default" NOT NULL,
    tipo_mantenimiento character varying(50) COLLATE pg_catalog."default" NOT NULL,
    ot_no character varying(50) COLLATE pg_catalog."default",
    equipo_intervencion character varying(100) COLLATE pg_catalog."default",
    hora_inicio timestamp without time zone NOT NULL,
    tag character varying(50) COLLATE pg_catalog."default",
    fluido character varying(50) COLLATE pg_catalog."default",
    presion character varying(20) COLLATE pg_catalog."default",
    temperatura character varying(20) COLLATE pg_catalog."default",
    empresa character varying(250) COLLATE pg_catalog."default",
    trabajo_area_riesgo_controlado character varying(2) COLLATE pg_catalog."default",
    necesita_entrega_fisica character varying(2) COLLATE pg_catalog."default",
    necesita_ppe_adicional character varying(2) COLLATE pg_catalog."default",
    area_circundante_riesgo character varying(2) COLLATE pg_catalog."default",
    necesita_supervision character varying(2) COLLATE pg_catalog."default",
    observaciones_analisis_previo text COLLATE pg_catalog."default",
    CONSTRAINT pt_no_peligroso_pkey PRIMARY KEY (id_ptnp)
);

CREATE TABLE IF NOT EXISTS public.sucursales
(
    id_sucursal integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT sucursales_pkey PRIMARY KEY (id_sucursal)
);

CREATE TABLE IF NOT EXISTS public.supervisores
(
    id_supervisor integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(100) COLLATE pg_catalog."default" NOT NULL,
    correo character varying(100) COLLATE pg_catalog."default",
    extension character varying(20) COLLATE pg_catalog."default",
    "contraseña" character varying(255) COLLATE pg_catalog."default" NOT NULL,
    usuario character varying(150) COLLATE pg_catalog."default",
    CONSTRAINT supervisores_pkey PRIMARY KEY (id_supervisor)
);

CREATE TABLE IF NOT EXISTS public.tipos_permisos
(
    id_tipo_permiso integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    nombre character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT tipos_permisos_pkey PRIMARY KEY (id_tipo_permiso)
);

ALTER TABLE IF EXISTS public.areas
    ADD CONSTRAINT fk_areas_departamentos FOREIGN KEY (id_departamento)
    REFERENCES public.departamentos (id_departamento) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.ast_actividades
    ADD CONSTRAINT ast_actividades_id_ast_fkey FOREIGN KEY (id_ast)
    REFERENCES public.ast (id_ast) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.ast_participan
    ADD CONSTRAINT ast_participan_id_estatus_fkey FOREIGN KEY (id_estatus)
    REFERENCES public.estatus (id_estatus) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.autorizaciones
    ADD CONSTRAINT autorizaciones_id_categoria_fkey FOREIGN KEY (id_categoria)
    REFERENCES public.categorias_seguridad (id_categoria) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.autorizaciones
    ADD CONSTRAINT autorizaciones_id_supervisor_fkey FOREIGN KEY (id_supervisor)
    REFERENCES public.supervisores (id_supervisor) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.permisos_trabajo
    ADD CONSTRAINT permisos_trabajo_id_area_fkey FOREIGN KEY (id_area)
    REFERENCES public.areas (id_area) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.permisos_trabajo
    ADD CONSTRAINT permisos_trabajo_id_ast_fkey FOREIGN KEY (id_ast)
    REFERENCES public.ast (id_ast) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.permisos_trabajo
    ADD CONSTRAINT permisos_trabajo_id_departamento_fkey FOREIGN KEY (id_departamento)
    REFERENCES public.departamentos (id_departamento) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.permisos_trabajo
    ADD CONSTRAINT permisos_trabajo_id_estatus_fkey FOREIGN KEY (id_estatus)
    REFERENCES public.estatus (id_estatus) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.permisos_trabajo
    ADD CONSTRAINT permisos_trabajo_id_sucursal_fkey FOREIGN KEY (id_sucursal)
    REFERENCES public.sucursales (id_sucursal) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.permisos_trabajo
    ADD CONSTRAINT permisos_trabajo_id_tipo_permiso_fkey FOREIGN KEY (id_tipo_permiso)
    REFERENCES public.tipos_permisos (id_tipo_permiso) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.pt_apertura
    ADD CONSTRAINT pt_apertura_id_permiso_fkey FOREIGN KEY (id_permiso)
    REFERENCES public.permisos_trabajo (id_permiso) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.pt_no_peligroso
    ADD CONSTRAINT pt_no_peligroso_id_permiso_fkey FOREIGN KEY (id_permiso)
    REFERENCES public.permisos_trabajo (id_permiso) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;

END;

-- Tablas principales
SELECT * FROM areas;
SELECT * FROM departamentos;
SELECT * FROM sucursales;
SELECT * FROM supervisores;
SELECT * FROM estatus;
SELECT * FROM tipos_permisos;
SELECT * FROM categorias_seguridad;

-- Tablas de AST (Análisis de Seguridad en el Trabajo)
SELECT * FROM ast;
SELECT * FROM ast_actividades;
SELECT * FROM ast_participan;

-- Tablas de permisos
SELECT * FROM permisos_trabajo;
SELECT * FROM pt_no_peligroso;
SELECT * FROM autorizaciones;


INSERT INTO tipos_permisos ( nombre) VALUES
( 'PT No Peligroso'),
( 'PT para Apertura Equipo Línea'),
('PT de Entrada a Espacio Confinado'),
('PT en Altura'),
('PT de Fuego Abierto'),
('PT con Energía Eléctrica'),
('PT con Fuentes Radioactivas'),
('PT para Izaje con Hiab con Grúa');




INSERT INTO jefe (usuario, "contraseña")
VALUES ('admin', 'admin123');







CREATE TABLE pt_apertura (
    id SERIAL PRIMARY KEY,
    id_permiso INTEGER NOT NULL REFERENCES permisos_trabajo(id_permiso),
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- Información General
    tipo_mantenimiento VARCHAR(50) NOT NULL,
    otro_tipo_mantenimiento VARCHAR(100),
    ot_numero VARCHAR(50) NOT NULL,
    tag VARCHAR(100),
    hora_inicio TIME NOT NULL,
    tiene_equipo_intervenir BOOLEAN,
    descripcion_equipo TEXT,
    
    -- Condiciones actuales
    fluido VARCHAR(100),
    presion VARCHAR(50),
    temperatura VARCHAR(50),
    antecedentes TEXT,
    
    -- Medidas para administrar riesgos
    requiere_herramientas_especiales VARCHAR(10) CHECK (requiere_herramientas_especiales IN ('SI', 'NO', 'N/A')),
    tipo_herramientas_especiales VARCHAR(255),
    herramientas_adecuadas VARCHAR(10) CHECK (herramientas_adecuadas IN ('SI', 'NO', 'N/A')),
    requiere_verificacion_previa VARCHAR(10) CHECK (requiere_verificacion_previa IN ('SI', 'NO', 'N/A')),
    requiere_conocer_riesgos VARCHAR(10) CHECK (requiere_conocer_riesgos IN ('SI', 'NO', 'N/A')),
    observaciones_medidas TEXT,
    
    -- Requisitos para efectuar el trabajo
    fuera_operacion VARCHAR(10) CHECK (fuera_operacion IN ('SI', 'NO', 'N/A')),
    despresurizado_purgado VARCHAR(10) CHECK (despresurizado_purgado IN ('SI', 'NO', 'N/A')),
    necesita_aislamiento VARCHAR(10) CHECK (necesita_aislamiento IN ('SI', 'NO', 'N/A')),
    con_valvulas VARCHAR(10) CHECK (con_valvulas IN ('SI', 'NO', 'N/A')),
    con_juntas_ciegas VARCHAR(10) CHECK (con_juntas_ciegas IN ('SI', 'NO', 'N/A')),
    producto_entrampado VARCHAR(10) CHECK (producto_entrampado IN ('SI', 'NO', 'N/A')),
    requiere_lavado VARCHAR(10) CHECK (requiere_lavado IN ('SI', 'NO', 'N/A')),
    requiere_neutralizado VARCHAR(10) CHECK (requiere_neutralizado IN ('SI', 'NO', 'N/A')),
    requiere_vaporizado VARCHAR(10) CHECK (requiere_vaporizado IN ('SI', 'NO', 'N/A')),
    suspender_trabajos_adyacentes VARCHAR(10) CHECK (suspender_trabajos_adyacentes IN ('SI', 'NO', 'N/A')),
    acordonar_area VARCHAR(10) CHECK (acordonar_area IN ('SI', 'NO', 'N/A')),
    prueba_gas_toxico_inflamable VARCHAR(10) CHECK (prueba_gas_toxico_inflamable IN ('SI', 'NO', 'N/A')),
    equipo_electrico_desenergizado VARCHAR(10) CHECK (equipo_electrico_desenergizado IN ('SI', 'NO', 'N/A')),
    tapar_purgas_drenajes VARCHAR(10) CHECK (tapar_purgas_drenajes IN ('SI', 'NO', 'N/A')),
    
    -- Requisitos para administrar riesgos
    proteccion_especial_recomendada VARCHAR(10) CHECK (proteccion_especial_recomendada IN ('SI', 'NO', 'N/A')),
    proteccion_piel_cuerpo VARCHAR(10) CHECK (proteccion_piel_cuerpo IN ('SI', 'NO', 'N/A')),
    proteccion_respiratoria VARCHAR(10) CHECK (proteccion_respiratoria IN ('SI', 'NO', 'N/A')),
    proteccion_ocular VARCHAR(10) CHECK (proteccion_ocular IN ('SI', 'NO', 'N/A')),
    proteccion_contraincendio VARCHAR(10) CHECK (proteccion_contraincendio IN ('SI', 'NO', 'N/A')),
    tipo_proteccion_contraincendio VARCHAR(255),
    instalacion_barreras VARCHAR(10) CHECK (instalacion_barreras IN ('SI', 'NO', 'N/A')),
    observaciones_riesgos TEXT,
    
    -- Registro de pruebas requeridas
    co2_nivel VARCHAR(20),
    nh3_nivel VARCHAR(20),
    oxigeno_nivel VARCHAR(20),
    lel_nivel VARCHAR(20)
);
